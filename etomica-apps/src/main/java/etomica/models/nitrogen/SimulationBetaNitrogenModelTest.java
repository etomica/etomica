/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

package etomica.models.nitrogen;

import etomica.action.BoxInflate;
import etomica.action.activity.ActivityIntegrate;
import etomica.atom.DiameterHashByType;
import etomica.box.Box;
import etomica.data.AccumulatorAverage;
import etomica.data.AccumulatorAverageCollapsing;
import etomica.data.DataPump;
import etomica.data.meter.MeterPotentialEnergy;
import etomica.graphics.SimulationGraphic;
import etomica.integrator.IntegratorMC;
import etomica.integrator.mcmove.MCMoveRotateMolecule3D;
import etomica.integrator.mcmove.MCMoveVolume;
import etomica.lattice.crystal.Basis;
import etomica.lattice.crystal.BasisHcp;
import etomica.lattice.crystal.Primitive;
import etomica.lattice.crystal.PrimitiveHexagonal;
import etomica.integrator.IntegratorListenerAction;
import etomica.molecule.IMoleculeList;
import etomica.normalmode.BasisBigCell;
import etomica.normalmode.MCMoveMoleculeCoupled;
import etomica.potential.PotentialMaster;
import etomica.potential.PotentialMolecular;
import etomica.simulation.Simulation;
import etomica.space.Boundary;
import etomica.space.BoundaryDeformablePeriodic;
import etomica.space.Space;
import etomica.space.Vector;
import etomica.space3d.Space3D;
import etomica.species.ISpecies;
import etomica.units.Degree;
import etomica.units.Kelvin;
import etomica.units.Pascal;
import etomica.units.Pixel;



/**
 * Simulation class for nitrogen molecules
 * beta-N2 crystal Structure
 * 
 * @author Tai Boon Tan
 *
 */
public class SimulationBetaNitrogenModelTest extends Simulation{

	
	public SimulationBetaNitrogenModelTest(Space space, int[] nC, double temperature, double pressure, double newScale) {
        super(space);
        this.space = space;
        double a = 3.840259;//3.854;
        double c = 6.263463;//6.284;
        int numMolecule = nC[0] * nC[1] * nC[2] * 2;

        potentialMaster = new PotentialMaster();
        Basis basisHCP = new BasisHcp();
        Basis basis = new BasisBigCell(space, basisHCP, new int[]{nC[0], nC[1], nC[2]});

        species = new SpeciesN2(space);
        addSpecies(species);

        Vector[] boxDim = new Vector[3];
        boxDim[0] = space.makeVector(new double[]{nC[0] * a, 0, 0});
        boxDim[1] = space.makeVector(new double[]{-nC[1] * a * Math.cos(Degree.UNIT.toSim(60)), nC[1] * a * Math.sin(Degree.UNIT.toSim(60)), 0});
        boxDim[2] = space.makeVector(new double[]{0, 0, nC[2] * c});
        Boundary boundary = new BoundaryDeformablePeriodic(space, boxDim);
        box = this.makeBox(boundary);
        box.setNMolecules(species, numMolecule);
        int[] nCells = new int[]{1, 1, 1};

        primitive = new PrimitiveHexagonal(space, (nC[0]) * a, nC[2] * c);

        coordinateDef = new CoordinateDefinitionNitrogen(this, box, primitive, basis, space);
        coordinateDef.setIsGamma();
        coordinateDef.setOrientationVectorGamma(space);
        coordinateDef.initializeCoordinates(nCells);
//		double[] u = new double[]{1.859243272094769,
//								-1.0153628168509197, 0.5264310520753508, -0.985084391977453, -0.4086283643460191};
//		double[] u = new double[]{1.631, 0.5525985761250363, -0.19555476100622327, 0.645737795271818, -1.3306305119973878,
//				0.5255646596605923, -1.0537416143377711, 1.3799501523364386, -0.2969260739976968};
        double[] u = new double[]{1.631, 0.3114947071600419, 1.0429061900017809, -0.2964122974419987, 0.8969092517921597,
                0.8358036263231321, -0.16195298831048305, 0.8895808121974509, -0.5632739667644824};


        int numCells = coordinateDef.getBasisCells().length;
        int numDOF = coordinateDef.getCoordinateDim();
        int cellDOFin1Dim = 2 * nC[2] * 5;

        System.out.println("cellDOFin1Dim: " + cellDOFin1Dim);

        /*
         * rotation only
         */
        double[] newU = new double[numDOF];

//		newU = new double[]{2.6645352591003757E-15, -8.881784197001252E-15, 1.7763568394002505E-15, 0.6262319250112304, -0.0310525560456201, 3.9968028886505635E-15, -5.773159728050814E-15, 8.881784197001252E-16, -0.8742937225537656, 0.9889374267221288, -8.881784197001252E-16, 8.881784197001252E-16, -1.7763568394002505E-15, 0.621221423057616, -0.03574906782845895, 7.771561172376096E-16, 4.440892098500626E-15, 1.9798977272481957E-15, 0.9914354960084603, -1.1343318311665282,
//				0.0, 4.440892098500626E-15, 1.7763568394002505E-15, 0.6256014581946576, -0.044051515570383296, 7.771561172376096E-16, -9.325873406851315E-15, -1.7763568394002505E-15, -0.8654551655001643, 0.991454640901383, 2.6645352591003757E-15, 2.4424906541753444E-15, 0.0, -0.7706442675824812, -1.141713787529017, 8.881784197001252E-16, 1.9984014443252818E-15, -6.217248937900877E-15, 0.5752444498073968, 0.05032757249605597,
//				3.552713678800501E-15, 1.5543122344752192E-15, 8.881784197001252E-16, -0.7743553318988916, -1.142836621778089, 8.881784197001252E-16, 4.440892098500626E-16, 2.3129646346357425E-16, 0.5788914896342263, 0.05394078583041276, 2.6645352591003757E-15, -4.440892098500626E-16, -1.3322676295501878E-15, 0.8141370282073508, 1.200775371989016, -1.3322676295501878E-15, -1.1102230246251565E-16, -1.7763568394002505E-15, -1.9066724544987832, -0.17237251754420457,
//				0.0, 1.9984014443252818E-15, 3.552713678800501E-15, 0.7018647495398044, -0.09929039737156217, 8.881784197001252E-16, -4.440892098500626E-15, 8.881784197001252E-16, -0.8395098868897191, 1.0894367754091223, -2.6645352591003757E-15, -6.661338147750939E-16, -4.440892098500626E-16, 0.6994615298166476, -0.0925934937972819, -1.7763568394002505E-15, 1.7763568394002505E-15, 1.3322676295501878E-15, 0.8803220497360352, -1.1552042304700132,
//				8.881784197001252E-16, 1.1102230246251565E-15, 8.881784197001252E-16, 0.7040979635846494, -0.0931154265076659, -1.7763568394002505E-15, -8.881784197001252E-16, -1.7763568394002505E-15, -0.8429233639304918, 1.0917139784210295, -3.4416913763379853E-15, 2.6645352591003757E-15, 7.105427357601002E-15, -1.888120819779927, 0.1920778466778603, 1.3322676295501878E-15, 0.0, 0.0, 0.9614240119808274, -1.1244803136575532,
//				0.0, -8.881784197001252E-16, 8.881784197001252E-16, 0.6273126106065818, -0.07345380625649885, -4.440892098500626E-16, -8.881784197001252E-16, 1.6838382540148207E-15, -0.8708148427534006, 1.019219346343038, -6.661338147750939E-16, 1.7763568394002505E-15, -8.881784197001252E-16, 0.630800553823104, -0.06845459190951518, -1.7763568394002505E-15, 4.884981308350689E-15, -7.105427357601002E-15, 0.9594203940360372, -1.1233789456932186,
//				2.220446049250313E-16, 1.7763568394002505E-15, 3.552713678800501E-15, 0.8134659185777668, 1.2130001113543118, -1.5543122344752192E-15, 1.4432899320127035E-15, -2.6645352591003757E-15, 0.5790268525267553, 0.07405869947900692, -4.218847493575595E-15, 4.218847493575595E-15, 8.881784197001252E-16, 0.8146661861547874, 1.2193548668332808, 1.1102230246251565E-15, -5.551115123125783E-16, -1.0177044392397268E-15, 0.5717665236526902, 0.07015933326294146,
//				3.3306690738754696E-16, 1.3322676295501878E-15, -1.7763568394002505E-15, -0.7631724007757134, -1.1303777151072405, -1.7763568394002505E-15, 3.3306690738754696E-16, -1.7763568394002505E-15, 0.5781651243589278, 0.0755826368345012, 8.881784197001252E-16, -8.881784197001252E-16, -3.552713678800501E-15, 0.6964795025702084, -0.0990944188591611, -4.551914400963142E-15, -4.440892098500626E-16, 3.552713678800501E-15, 0.8741975356273234, -1.16533217271772,
//				7.105427357601002E-15, 1.3322676295501878E-15, -4.440892098500626E-16, 0.6925804337837808, -0.1020950876149362, 9.992007221626409E-16, 0.0, 8.881784197001252E-16, -0.8234629982586892, 1.0958855610917113, -8.881784197001252E-16, 2.220446049250313E-16, 2.220446049250313E-15, 0.6936545263590994, -0.0989872694992802, 1.6653345369377348E-15, -3.552713678800501E-15, 8.881784197001252E-16, 0.8777469405851456, -1.1633592776967123,
//				5.329070518200751E-15, 5.329070518200751E-15, 1.7763568394002505E-15, 0.6419065371321047, -0.061616953093702735, 2.6645352591003757E-15, -6.217248937900877E-15, 8.881784197001252E-16, -0.8906214643075238, 1.0184895156124552, 1.7763568394002505E-15, -8.881784197001252E-16, -8.881784197001252E-16, 0.6444846845003986, -0.05336839783174256, -2.6645352591003757E-15, -8.881784197001252E-15, -2.6460315420232896E-15, 0.9710133998502695, -1.1079349585046863,
//				-2.6645352591003757E-15, 2.6645352591003757E-15, -1.7763568394002505E-15, 0.6373969589509338, -0.05945171535311347, 3.552713678800501E-15, -1.7763568394002505E-15, -2.6645352591003757E-15, 0.9664155641993127, -1.1083677575858484, -3.1086244689504383E-15, 0.0, 3.552713678800501E-15, 0.7962873661586418, 1.211491690221616, -8.881784197001252E-16, 8.881784197001252E-16, 0.0, 0.5852647227718966, 0.051077982325347195,
//				1.7763568394002505E-15, 1.3322676295501878E-15, -2.6645352591003757E-15, 0.794487023116861, 1.2086565026362535, -4.440892098500626E-15, 8.881784197001252E-16, -5.643633708511212E-16, 0.5881434170456552, 0.05100899526538786, -1.3322676295501878E-15, 3.1086244689504383E-15, -8.881784197001252E-16, 0.7986260169989221, 1.2080583359894657, -8.881784197001252E-16, 6.217248937900877E-15, -3.552713678800501E-15, -1.9028683782878868, -0.16637091465388343,
//				-1.6653345369377348E-15, -4.440892098500626E-16, -1.0658141036401503E-14, 0.6966578914216564, -0.13948992222985884, 2.6645352591003757E-15, 1.7763568394002505E-15, 2.6645352591003757E-15, -0.8112714071697293, 1.1203508685012802, 9.992007221626409E-16, -1.5543122344752192E-15, -2.220446049250313E-15, 0.6960791291280785, -0.1349389213202987, -8.881784197001252E-16, 0.0, -1.4432899320127035E-15, 0.8520601811321995, -1.1636136507309878,
//				1.5543122344752192E-15, 1.1102230246251565E-15, 0.0, 0.693696677639417, -0.13711318659620436, -2.6645352591003757E-15, -3.9968028886505635E-15, -1.7763568394002505E-15, -0.8172710080677392, 1.1163653423938338};
        /*
         * GOOD STRUCTURE!!!
         */
        newU = new double[]{
                0.16271482364587975, -0.043161180877659966, 0.007663734162299818, 0.6014548067620191, 6.433610675944939E-4, 0.2112062052821836, 0.07490627646231918, -0.007546463529727987, -0.8451981680256074, 1.0611364731360589, 0.22325465414083023, -0.021999939330763496, 0.005730387908259527, 0.621603772614268, -0.012091713054584199, 0.21859058307731782, 0.04020097779628351, 0.009328198304599317, 0.9389881881928034, -1.1454366913949756,
                0.1866780040645062, -0.07247120094763382, 0.022623501504440036, 0.611186934339621, -0.011713989464443351, 0.21303152995071628, 0.013212955794995374, 0.018243652845832514, -0.856109772962173, 1.078737677011623, -0.03464479336475179, 0.02444303510505952, -0.020284039848391444, -0.7417022193287907, -1.1535685767533315, -0.03184759865238895, 0.06931464497007378, -0.007424722782398696, 0.5667534697636806, 0.07161198838142355,
                0.03740067225834043, -0.01409275609631333, -0.0169413426962306, -0.7409135000696522, -1.1509852658633706, -0.037814009435185536, 0.018795360490309942, -0.020940858644354344, 0.5471583717668315, 0.08365236950918387, -0.013300642564081144, -0.06771964525147922, -0.021706397189590998, 0.8126203463745004, 1.2006700658827476, -0.022318313346512575, 0.01003384747757452, -0.025377324481480557, -1.9022822791097245, -0.19547141068208806,
                -0.2112480153851477, -0.012919344719904746, 0.008827803265461398, 0.6728474849548558, -0.07497285214858836, -0.2158747359643911, 0.07836132481102309, 0.014012972676913371, -0.8078193666656063, 1.1292041622794589, -0.19407229097711998, -0.017642399890283045, 0.006105162548185383, 0.6573004594245654, -0.03953646905403684, -0.19404376012399105, 0.0569649736568727, 0.010402414735270796, 0.848974753524898, -1.153181319209721,
                -0.19410955126659424, -0.06059652767542767, -0.005655306377787106, 0.6451203453338527, -0.025684940635098477, -0.14124033805797254, -0.016412120897984384, 0.009110869661242305, -0.8238188302306108, 1.141610980988381, 0.16924267579033248, -0.014693738027048653, 0.012916002758828427, -1.903594978173397, 0.11638082080601708, 0.21515755883990373, 0.060077256781761346, -0.0031626884241902076, 0.9228491092463958, -1.1491104992171355,
                0.21695165642466385, -0.0192926472718975, 0.012359958309216879, 0.628114528816382, -0.034396205596747685, 0.22320039094222066, 0.025848649834726345, 0.011188796378439909, -0.8512276896187967, 1.0420195497834173, 0.1842368119814881, -0.06375282427871642, 0.029466295461145098, 0.6197243517291073, -0.03220218070422768, 0.22760313344389482, 0.002091377769728453, 0.020756644633916466, 0.8852384821135997, -1.1432904585414991,
                -0.04237440270300308, 0.04066856621778925, -0.026843357820689917, 0.7858147261035296, 1.2309003251323791, -0.028167324306448194, 0.06706439887869109, -0.010762712330271818, 0.5625983736547867, 0.07179673723952931, 0.03973309327237151, -7.807358376994422E-4, -0.017107776205359304, 0.7840994471675581, 1.2350958260571563, -0.013298627340974312, 0.016442605266115184, -0.020737579677376772, 0.5497757550000717, 0.07927039074807943,
                -0.0057453955054268535, -0.04918088563044387, -0.021993924394414943, -0.7514511524521691, -1.1316438697802642, -0.013286748001817172, -0.018648848245006566, -0.031105974502720457, 0.5597261199771552, 0.0760581762661763, -0.22855020321052688, -0.007836640552076002, 0.01259956420077124, 0.6689649236144585, -0.10194394689722573, -0.21125138060764848, 0.06942405584366007, 0.018924373524612292, 0.8401887626383765, -1.1947233521768208,
                -0.20558377155086305, -0.013537215609081832, 0.011222443623784883, 0.6431712863839778, -0.05358369988965012, -0.1941528501694404, 0.03669593600637455, 0.011505191524907216, -0.7889761333795239, 1.1144831058100286, -0.21258490158732135, -0.06593258665350432, -0.007260136820868013, 0.6436690074700653, -0.055484835633666234, -0.13815145014858154, -0.03233680302977904, 0.014081814605110488, 0.8451162634159807, -1.1649509368802566,
                0.16754239440152574, -0.04581560960978415, 0.011306931600234549, 0.6103739487555917, -0.04637572921364545, 0.2122362357688914, 0.06095441955880743, -0.007585000696002986, -0.8562396904376854, 1.078543590593873, 0.2213393132525603, -0.03039848768955533, 0.011011384853130135, 0.6291271246749511, -0.04597323411078163, 0.2168347843742815, 0.022120691215083532, 0.01138836216921435, 0.9287128357704446, -1.1266444707949907,
                0.17754804680815806, -0.1053649929510394, 0.026917385893185486, 0.6226935538333076, -0.04641102847901104, 0.216047786466377, 0.002521778501031857, 0.015914705710748933, 0.859320720874914, -1.1249278492862664, -0.031874349769297705, 0.029026772423349723, -0.02170964957723953, 0.7791889022227002, 1.2383207148076945, -0.02946010686058198, 0.05333096069992116, -0.008702659037904681, 0.5639196972872595, 0.06502195678347332,
                0.043041976942276516, -0.012512398129642222, -0.017443229653935077, 0.7728438188750217, 1.235198568203537, -0.026651658224828623, 0.0223834942533212, -0.022712188527622995, 0.5612869596219668, 0.05455755814041107, 0.016134373327676865, -0.06445100837598261, -0.015634266284324738, 0.79921661520357, 1.2182342237651438, -0.0057236572597254565, -0.011261739335073906, -0.023707185755085902, -1.9014974006848115, -0.21187132543610998,
                -0.21586847186576008, -0.01734501069533212, 0.006559395784030642, 0.6800661416613007, -0.14513352767440998, -0.20559126944690398, 0.07341529721598539, 0.015518857524483565, -0.8153712775241989, 1.1462478745238587, -0.19402001877895347, -0.01717262057357649, 0.010843706147130483, 0.654892760599107, -0.08520128666513893, -0.17950055183766178, 0.05115476967962307, 0.009096057763868015, 0.8306011891716286, -1.165600161208513,
                -0.1940008845943153, -0.06956297705749193, -0.008561972373742233, 0.6388241794369601, -0.0877481133302751, -0.13337463154825535, -0.03256154147019119, 0.005280187552518356, -0.8160966571923565, 1.158972464810011};


        /*
         * 4 x 4 x 4
         */
//		newU = new double[]{
//				3.1086244689504383E-15, -4.440892098500626E-15, 0.0, -0.10330139988595498, 0.6762165537376675, 8.881784197001252E-16, -8.881784197001252E-16, -5.329070518200751E-15, -0.30105333784245647, 0.20593408637832192, 8.881784197001252E-16, 8.881784197001252E-16, 3.552713678800501E-15, 0.472513412890253, -0.31075607918217524, 2.220446049250313E-16, 1.7763568394002505E-15, 4.884981308350689E-15, 1.341809963435767, -0.3804532593920294,
//				-4.440892098500626E-16, -8.881784197001252E-16, 1.6190752442450199E-16, 0.43242558134577097, 1.5603285078528029, -6.661338147750939E-16, -8.881784197001252E-16, 0.0, -0.30306390044916387, 0.2999162132183413, 4.884981308350689E-15, 0.0, 3.552713678800501E-15, 1.336011560026607, -0.09613952290971674, 3.774758283725532E-15, 1.7763568394002505E-15, 1.7763568394002505E-15, 1.4470760964614886, 0.37619894836548906,
//				-4.440892098500626E-15, 3.1086244689504383E-15, 1.7763568394002505E-15, 1.559414688783979, -0.03641269291449023, -4.440892098500626E-16, 3.1086244689504383E-15, -5.329070518200751E-15, 0.5148439145749425, 1.021971758927725, 6.217248937900877E-15, -4.440892098500626E-16, 3.552713678800501E-15, 0.3534776138918542, 1.491903001273269, 5.329070518200751E-15, -8.881784197001252E-16, 0.0, -0.43824078928026194, 0.30196652647322453,
//				-8.881784197001252E-16, -4.440892098500626E-16, 2.0354088784794536E-16, 1.2619968629649405, 0.1152227345723249, -4.440892098500626E-16, -8.881784197001252E-16, -1.3322676295501878E-15, 1.4232941715384915, 0.21174990698645138, 0.0, -1.7763568394002505E-15, 8.881784197001252E-16, 0.3996062589122349, 1.5794075168520452, 1.3322676295501878E-15, -4.440892098500626E-16, 0.0, -0.2516019164965537, 1.8089447809603696,
//				1.7763568394002505E-15, -2.2204460492503128E-16, -3.552713678800501E-15, -0.10695741920027621, 0.671389533166301, 5.329070518200751E-15, 1.3322676295501878E-15, 0.0, -0.29926518911053257, 0.20713160723491758, -1.5987211554602254E-14, 3.9782991715734773E-16, 3.552713678800501E-15, 0.47011598412016825, -0.3103495863861618, -8.881784197001252E-16, 1.1102230246251565E-15, 2.6645352591003757E-15, 1.3444975973597315, -0.3782289273057229,
//				1.2434497875801753E-14, -8.326672684688673E-16, 3.885780586188048E-16, 0.4266735924370654, 1.5633036337835498, -1.7763568394002505E-15, 0.0, 0.0, -0.3040445379849664, 0.2984253358438639, 3.552713678800501E-15, 3.946495907847235E-15, -3.552713678800501E-15, 1.3341345246849952, -0.08945093811031377, -3.552713678800501E-15, -4.440892098500626E-15, -1.7763568394002505E-15, 1.4452748983991883, 0.37621912119823103,
//				0.0, 0.0, 1.7763568394002505E-15, -1.247802352155214, 0.025869804416069123, 3.552713678800501E-15, -4.440892098500626E-15, -5.329070518200751E-15, -0.7431004503107569, -1.4662649876065197, 3.552713678800501E-15, -1.1546319456101628E-14, 8.881784197001252E-16, 0.35320318216984403, 1.4926465597366891, -1.7763568394002505E-15, 2.6645352591003757E-15, -1.7763568394002505E-15, -0.4386112069654319, 0.3029735005464207,
//				1.7763568394002505E-15, -2.220446049250313E-15, 2.9050835811024927E-15, 1.261039324641083, 0.11616929024777677, 0.0, -4.440892098500626E-15, 0.0, 1.4247045676788865, 0.20883012434521941, 1.7763568394002505E-15, -2.220446049250313E-15, 4.440892098500626E-15, 0.3957519034173513, 1.5791248182836244, -8.881784197001252E-16, 3.552713678800501E-15, 0.0, 0.1041854480736483, -0.8026611023350281,
//				-9.066821367772113E-16, 8.881784197001252E-16, 1.7763568394002505E-15, 0.5032510856873544, -0.3486332509304787, -8.881784197001252E-16, 0.0, -3.552713678800501E-15, 1.3702774884204227, -0.2052792383845571, -9.506284648352903E-16, 8.881784197001252E-16, 8.881784197001252E-16, -0.24959376580167927, 0.6777479510291229, 2.6645352591003757E-15, -8.881784197001252E-16, -1.7763568394002505E-15, 0.13137194576525643, 1.249715305713517,
//				-7.355227538141662E-16, 4.440892098500626E-15, 3.3954320836452703E-15, 0.9967070280194497, -1.446853790586915, 2.220446049250313E-15, 3.552713678800501E-15, 8.881784197001252E-16, 0.45534004144135154, -0.5956415086834703, -4.625929269271487E-16, 8.881784197001252E-16, -2.6645352591003757E-15, 0.23635387416436007, -0.18403011437121197, -2.220446049250313E-16, 2.6645352591003757E-15, 1.7763568394002505E-15, -0.4323204095464666, 0.1810015466932476,
//				-2.4424906541753444E-15, 4.440892098500626E-16, 1.7763568394002505E-15, 0.3981692891736083, 1.49116335318154, 1.052398908759263E-15, 2.220446049250313E-15, 3.552713678800501E-15, -0.2861167117483919, 1.7959283209199648, 0.0, -1.3322676295501878E-15, 8.881784197001252E-16, 1.4436936872097454, -0.16620533875191557, -5.9211894646675E-16, 3.1086244689504383E-15, 1.3322676295501878E-15, 0.2886101414022644, -0.5741165467512562,
//				1.1102230246251565E-15, 0.0, -1.9197606467476664E-16, 0.09902705026611353, -0.1635279167494486, 3.885780586188048E-16, 1.7763568394002505E-15, 1.7763568394002505E-15, 0.16093097276009555, 1.2610739187417372, 2.4424906541753444E-15, 3.1086244689504383E-15, -1.7763568394002505E-15, 0.9812482467577069, -1.483266954892221, -1.1102230246251565E-15, -8.881784197001252E-16, -3.552713678800501E-15, -0.5024935291472283, -1.6053104698914356,
//				5.773159728050814E-15, -7.031412489292658E-16, 0.0, 0.4965938197267531, -0.34639263059732245, -8.881784197001252E-16, -4.440892098500626E-16, 1.7763568394002505E-15, 1.3711101283554452, -0.19915924604617613, 0.0, -6.29126380620922E-16, 1.7763568394002505E-15, -0.25031128602299935, 0.6766734108011049, -2.220446049250313E-15, -1.7763568394002505E-15, 1.3322676295501878E-15, 0.13082936430625094, 1.2492615269856289,
//				-8.881784197001252E-16, 4.625929269271486E-16, 1.7578531223231644E-16, 0.9938765749891731, -1.4469800458422568, 1.9984014443252818E-15, -4.440892098500626E-16, 8.881784197001252E-16, 0.4541384737116237, -0.5971976270934746, 3.9968028886505635E-15, 8.881784197001252E-16, -6.217248937900877E-15, 0.23606243600436438, -0.1815042431871111, -2.220446049250313E-15, 2.220446049250313E-16, -3.552713678800501E-15, -0.4324437441741159, 0.18086557694320862,
//				-1.7763568394002505E-15, -2.6645352591003757E-15, 1.7763568394002505E-15, 0.3954850976945785, 1.4898100724035495, 0.0, 1.7763568394002505E-15, 1.7763568394002505E-15, 0.12969057166292958, -0.8148097572196946, 0.0, -4.440892098500626E-16, 8.881784197001252E-16, -1.363305266456768, 0.15737743325594097, 1.7763568394002505E-15, -3.552713678800501E-15, 0.0, -0.8533212664917029, 1.690247765301825,
//				1.7763568394002505E-15, 1.3322676295501878E-15, 5.551115123125783E-17, 0.09813114748259018, -0.16555532293856923, 4.440892098500626E-16, -1.7763568394002505E-15, 4.440892098500626E-16, 0.15594811875933756, 1.2617647610268947, 0.0, -3.552713678800501E-15, -1.7763568394002505E-15, 0.982301205242761, -1.4826171950796212, -8.881784197001252E-16, 8.881784197001252E-16, 0.0, 0.32495812291612075, 1.032041588621858,
//				8.881784197001252E-16, -3.552713678800501E-15, -7.105427357601002E-15, -0.10348442312130489, 0.6757549517982241, -5.329070518200751E-15, -7.105427357601002E-15, -3.552713678800501E-15, -0.29937476530511065, 0.20367095281447162, 2.6645352591003757E-15, 0.0, 1.7763568394002505E-15, 0.46984288009706776, -0.3121800042152689, 8.881784197001252E-16, 1.7763568394002505E-15, -8.881784197001252E-16, 1.342666453633635, -0.3864661011533967,
//				3.552713678800501E-15, 8.881784197001252E-16, 3.423187659260899E-16, 0.42718103097116367, 1.5621251530358669, 8.881784197001252E-16, 0.0, 4.440892098500626E-16, -0.2994371530263761, 0.29867093669207123, -2.6645352591003757E-15, 8.881784197001252E-16, -2.6645352591003757E-15, 1.3342886303398096, -0.09481205246272774, 0.0, -8.881784197001252E-16, 0.0, 1.4491614497775527, 0.37090357814972075,
//				-1.1102230246251565E-15, 0.0, 1.7763568394002505E-15, 1.5603590210626757, -0.033745219162056465, 4.440892098500626E-16, 2.220446049250313E-15, -5.329070518200751E-15, 0.5161391238982236, 1.0191024429373625, 8.881784197001252E-16, 2.220446049250313E-15, 1.7763568394002505E-15, 0.35156454072330945, 1.491729026776608, 3.9968028886505635E-15, -1.3322676295501878E-15, -4.440892098500626E-16, -0.436198622684095, 0.3029404646324508,
//				0.0, -4.440892098500626E-16, 8.696747026230393E-16, 1.2627804194583145, 0.11612228990640173, -8.881784197001252E-16, -1.3322676295501878E-15, -1.7763568394002505E-15, 1.4235782178640826, 0.21224599155839163, 3.552713678800501E-15, 2.220446049250313E-15, -1.7763568394002505E-15, 0.3989981445198203, 1.5791732686566589, 0.0, -2.220446049250313E-15, 1.7763568394002505E-15, 0.11068570824655201, -0.8092364167776508,
//				2.012279232133096E-16, 4.4408920985006257E-16, 3.552713678800501E-15, -0.10771580302307916, 0.6711788469416645, 1.3322676295501878E-15, -3.552713678800501E-15, 3.552713678800501E-15, -0.29717115501121033, 0.2053562892352191, -4.4408920985006257E-16, -8.696747026230393E-16, -1.7763568394002505E-15, 0.4674338857708158, -0.3107098301701348, -5.329070518200751E-15, -8.881784197001252E-16, 1.7763568394002505E-15, 1.3453371481080854, -0.38376246016229193,
//				2.0354088784794536E-16, 5.551115123125783E-17, -4.625929269271485E-18, 0.42443215832741815, 1.5630017921900625, -1.9984014443252818E-15, -1.3322676295501878E-15, 8.881784197001252E-16, -0.3030636037770519, 0.2975394033837071, 8.673617379884034E-16, 9.055256544598933E-16, 0.0, 1.332752376803275, -0.09324771704206222, 8.881784197001252E-16, 8.881784197001252E-16, 0.0, 1.4461743119409436, 0.37591446278363644,
//				-3.9968028886505635E-15, 0.0, 1.7763568394002505E-15, 1.5627919337741376, -0.031977044960531255, -1.609823385706477E-15, -1.7763568394002505E-15, 7.105427357601002E-15, 0.5155581165334796, 1.0159103583288682, -2.6645352591003757E-15, 0.0, -2.6645352591003757E-15, 0.3541451688061984, 1.4922706764633642, 4.4408920985006257E-16, -8.881784197001252E-16, 0.0, -0.43664015880954576, 0.3022664905199414,
//				1.3322676295501878E-15, 1.3322676295501878E-15, -1.1287267417022424E-15, 1.2645045703196296, 0.11497698104923372, 1.8943180357666733E-15, -8.881784197001252E-16, 0.0, 1.422665466380137, 0.21135348343288843, 1.9984014443252818E-15, -8.881784197001252E-16, 1.7763568394002505E-15, 0.39198477065756315, 1.5801319246252667, -1.1784554813469108E-15, -8.881784197001252E-16, 0.0, -0.23150062962880413, 1.813257907003902,
//				8.881784197001252E-16, 3.552713678800501E-15, -5.329070518200751E-15, 0.5033937368606487, -0.3523289541830055, -3.552713678800501E-15, 1.7763568394002505E-15, 3.552713678800501E-15, 1.371067962838835, -0.2028727613790878, 3.552713678800501E-15, -2.6645352591003757E-15, -1.7763568394002505E-15, -0.25097939776119793, 0.6829067877870929, -3.552713678800501E-15, 2.6645352591003757E-15, -2.220446049250313E-15, 0.1332807359328439, 1.2507755894182935,
//				0.0, 3.552713678800501E-15, 1.6190752442450198E-15, 0.993637374312931, -1.4501433252850262, -3.552713678800501E-15, 0.0, -1.3322676295501878E-15, 0.4570177779923392, -0.595479687126157, 4.440892098500626E-15, 0.0, -1.7763568394002505E-15, 0.2340984320083898, -0.1840031314841154, 0.0, 0.0, 3.552713678800501E-15, -0.4319814892472494, 0.1810776899504351,
//				1.7763568394002505E-15, 0.0, 0.0, 0.4021707957890722, 1.4914943322564516, -1.7763568394002505E-15, 6.217248937900877E-15, -3.552713678800501E-15, -0.287541718066731, 1.7957349272295582, 1.7763568394002505E-15, -3.1086244689504383E-15, 8.881784197001252E-16, 1.4411549619939452, -0.16442093711120784, 0.0, 1.7763568394002505E-15, 1.3322676295501878E-15, 0.28924208503884863, -0.5767532139183456,
//				-1.7763568394002505E-15, -4.440892098500626E-16, 9.020562075079397E-17, 0.09768887841688385, -0.16371076498924766, -7.105427357601002E-15, 1.7763568394002505E-15, 0.0, -0.19074819336256574, -1.532520796986358, -1.7763568394002505E-15, -4.440892098500626E-16, -1.7763568394002505E-15, 0.9783972005992626, -1.4844409416230833, 7.105427357601002E-15, 3.1086244689504383E-15, 0.0, 0.3263272250426747, 1.0327384232280925,
//				-1.7763568394002505E-15, -1.6283271027835629E-15, 1.7763568394002505E-15, 0.49928078703902856, -0.3462812760229365, -1.7763568394002505E-15, -1.3322676295501878E-15, -3.552713678800501E-15, 1.3714480064894519, -0.1983336489932169, -2.6645352591003757E-15, 2.3129646346357427E-15, -1.7763568394002505E-15, -0.2501127012232984, 0.6808757488741327, -4.440892098500626E-15, -1.3322676295501878E-15, -4.440892098500626E-16, 0.12707257396619803, 1.252422560748878,
//				-1.3322676295501878E-15, 3.700743415417188E-17, 7.401486830834377E-17, -0.5431443430087147, 0.7921872310339425, -8.881784197001252E-16, -1.9984014443252818E-15, -8.881784197001252E-16, 0.45595833291202026, -0.5973092377957686, 8.881784197001252E-16, 1.0362081563168126E-15, 0.0, 0.23585082961368603, -0.1817603206456851, 2.6645352591003757E-15, 3.1086244689504383E-15, -1.7763568394002505E-15, -0.433473150177996, 0.1826513115206321,
//				-2.220446049250313E-15, -2.6645352591003757E-15, 1.7763568394002505E-15, 0.3991580436014877, 1.4906747476227011, 2.220446049250313E-15, -4.440892098500626E-15, -5.329070518200751E-15, 0.12777790634748218, -0.8132510875362103, -3.774758283725532E-15, -1.7763568394002505E-15, 8.881784197001252E-16, 1.4426014763082993, -0.16808029447674916, 2.220446049250313E-15, -8.881784197001252E-16, 0.0, 0.28945650112493726, -0.5785818199045719,
//				2.6645352591003757E-15, 1.3322676295501878E-15, 1.0177044392397268E-16, 0.09641662224651248, -0.16674321475553847, 1.7763568394002505E-15, 1.7763568394002505E-15, 0.0, 0.15630837732075512, 1.2609749259774699, -8.881784197001252E-16, -8.881784197001252E-16, -3.552713678800501E-15, 0.983734427266128, -1.4794533140051027, 4.440892098500626E-15, -1.7763568394002505E-15, -1.7763568394002505E-15, -0.5132106616016704, -1.6028784537931184};

        /*
         * translation and rotation
         */
//		newU = new double[]{
//				-0.017041805739255622, 0.0019487303768803699, 0.027613883089692592, -0.09595959777264396, 0.6813495109134212, -0.0018177506964400791, -0.0026483103155232612, -0.03134989009219069, -0.2952030251233324, 0.21139469298486663, -0.008578594386920102, -0.007966528268891437, -0.008453560656156434, 0.48244709737471814, -0.2907842466129936, -0.012833914522005552, -0.056675844349523885, 0.036555769708592756, 1.3676727854762096, -0.32273243111035477,
//				0.002051206697768926, 0.0013785277477005309, -0.003611882014801726, 0.4833632552244996, 1.5320795982735034, 0.008869380224105994, 0.006332093070543721, -0.03422660624881413, -0.2993138574401832, 0.3029218585134683, -0.05678400835911912, 0.0010104957322703, -0.04038556446374031, 1.3518817703236656, -0.11005092063762822, 0.025687645850251073, 0.04366718040285811, 0.037677995675988285, 1.4559482710811296, 0.3076564925578897,
//				0.021161524598418247, 0.03986071226752008, -0.032759435127985626, 1.538173709999941, -0.016406846738222538, -0.0020901845453775714, -0.00830559487254634, 0.013197413902080513, 0.5419437694557109, 1.0062912691940562, 0.004658874289493298, 0.036205680778259364, 0.04121188909836171, 0.3255258432652376, 1.4850715746270162, 0.0068020588296668905, 0.001008575377479115, -0.018300016255064833, -0.44707850933871085, 0.29440809216234287,
//				-0.021352254447499774, -0.017647207330843795, -0.03203567157146201, 1.296574198628837, 0.1170415150340277, 0.04613961718172055, 0.03886808596804636, 0.035568294821250124, 1.4292962071584572, 0.20137109594888228, -0.032373466257589634, -0.02448207619893017, 0.04436843504594101, 0.37571293669657835, 1.6005188364375382, 0.027448545934271262, -0.0035323548891330603, -0.017092382521362026, -0.2516571547505903, 1.8049040853282936,
//				-0.011627996542686425, -0.002198608175106864, 0.018104137711699053, -0.09173549912515402, 0.6778243607895967, -0.0024085263578657035, -0.0043006205299176425, -0.03595902000924234, -0.2969289434398993, 0.20310748275921833, -0.005927444090387368, -0.006042406890076235, -0.006353732011998403, 0.4799035915242918, -0.2903313091069553, -0.018222615471779058, -0.05554733975522086, 0.04085029462754086, 1.3673192583396654, -0.3176483237743629,
//				-0.004928067233707978, -0.0016307009006599298, 3.422813237977338E-4, 0.47014836128422827, 1.5393122606796092, 0.009930268880614435, 0.00592025532588325, -0.03565586816653887, -0.29673737843061054, 0.3017449998197483, -0.056625186507585745, -0.003862662214714642, -0.04616412645329504, 1.3547776969492809, -0.0900824846889546, 0.039989030696618855, 0.04380717876132323, 0.03555614958237818, 1.458647717561083, 0.3071371149040535,
//				0.021215318387472593, 0.03051497971455497, -0.034223774068554036, -1.2830740415867514, 0.0011313599346718865, 0.010262897958837058, 0.0029561727062050736, 0.010229251056596667, -0.7784497417705855, -1.4436286540360659, -0.004249505030973211, 0.03890195694595189, 0.04343285428686361, 0.3249340694403229, 1.4829062922365746, 0.0065449014307397135, -0.0015434881715936655, -0.018051230500035764, -0.44390248178239566, 0.295767310905078,
//				-0.03344787987151143, -0.02220853553984714, -0.03596916703426718, 1.2937220940819776, 0.10688658355021077, 0.0330766822122488, 0.0373526359097216, 0.03677364412483897, 1.4355312145919727, 0.19106908899017264, -0.02866429190812525, -0.02236719221877337, 0.04763179978496801, 0.35655307837012595, 1.6024344622077884, 0.021894253578636835, -0.0027460456808476863, -0.022059481275668702, 0.12099144693245066, -0.8105218664113911,
//				-0.026355117199472384, -0.016823693966060205, -0.00795595207494948, 0.4821021231652145, -0.32954869791394903, -0.026000006603566606, -0.036954001259062785, 0.03778530400450286, 1.3839870369045997, -0.19533144469214442, 0.0031399908752729314, 0.071896038679653, 0.004247291975264744, -0.24230862621655458, 0.6953312045665545, 0.021942861859922003, -0.01713724236650993, -0.020294764555675915, 0.1399253046272015, 1.249545027110905,
//				-3.866847983922487E-5, 0.024721018428546238, -0.003243378674198262, 0.9946875656254829, -1.4631053419280209, 0.026778324279121968, -0.0199675439182041, 0.011469786640984303, 0.4846644821302087, -0.5889756089685677, -0.059809178007973085, -0.03781670282827587, 0.004454486678787006, 0.23225114456110088, -0.20105850561891878, -0.007530473314782293, -0.004666043444396806, -0.022167212596414743, -0.43299363849564626, 0.18645241704291454,
//				0.01664135868980754, -0.004007790777142528, 4.1154510838659064E-4, 0.434944949301936, 1.4806958504212187, 0.005214579441691676, -0.001858105814822597, -0.00302694239839596, -0.23922395797587234, 1.8097070841422018, -0.03305624400756746, 0.05317251741121565, -0.03955221811970855, 1.4259616647878106, -0.15035204011919578, -0.004941716492369558, -0.03855250298302426, 0.01080348428550515, 0.27773927380400654, -0.6238736541380518,
//				-0.0016194681098173902, 0.012527489506171552, 0.019053555098334785, 0.08716962698726863, -0.17189304534003882, 0.04873967232203944, -0.013797607234140141, -0.005457486659695032, 0.125002566368206, 1.2521023637934765, -0.0073623125720649885, 0.011503788539406923, -0.006387977188390792, 1.010999056449124, -1.4662566168026978, 0.0412934578076447, 0.018911254065556715, 0.010588509917237587, -0.4670699815662333, -1.5906256117386381,
//				-0.01010046964406186, -0.011171313335829287, -0.0033528132844118375, 0.4775124693457675, -0.3315849237163672, -0.019371920876736004, -0.04018656359769657, 0.03568787185143307, 1.3738969675922885, -0.20170745756228964, 0.0032086403922377826, 0.07847656985221672, 0.0047489902536757, -0.24676002641471514, 0.6953294357081081, 0.024265205468483986, -0.011356138169530183, -0.018092290628235475, 0.1458222049672157, 1.252773125676416,
//				-0.004537754226709545, 0.02835640277038263, -0.004460888656747615, 0.9747596864137587, -1.4742484846740969, 0.020325162619376336, -0.018238319323573338, 0.01199568579615029, 0.4802317150451372, -0.5885048208141791, -0.06329065227179864, -0.03972174721302483, 0.002431968916452476, 0.2252072808238525, -0.20351326083415164, -0.00548785019497422, -0.004763011577313181, -0.01799814078920825, -0.43346292012235665, 0.18606633249664434,
//				0.0046136216173344735, -0.0025448010993969206, -0.0050579166678090814, 0.43635380592715395, 1.4872080677450452, 0.010131068846004343, -0.012610455655658548, -0.009808027053301416, 0.1040208191108586, -0.8031717312447652, -0.03682681269892196, 0.049732123743939205, -0.04563785805797593, -1.390219817608375, 0.1498659224019755, -0.0074431962786660755, -0.05498591955606269, 0.00812016606694499, -0.7669467639195161, 1.7151148218879795,
//				-0.011684734603756297, 0.026406250447008173, 0.022856791156277777, 0.08869716273114006, -0.1662544267913066, 0.045615692338983216, -0.009480177339674434, -0.0041292612281047525, 0.11251554567482339, 1.248820470626937, 0.0044717830374150225, 0.014443838282828914, -0.007376513548030594, 1.0190374196639629, -1.462067875794017, 0.04126605535364636, 0.028240239384421884, 0.012854225068224423, 0.31701363899939894, 1.0736770413062473,
//				-0.03061183585145022, 0.011049375823744434, 0.017980098814675216, -0.09264450684812947, 0.6834353660636722, -0.02401340339614233, -0.002992330380971353, -0.03708649048015644, -0.29191702231943967, 0.19866369392713593, -0.012120876172152961, -0.00836096603721348, -0.0033737668564723933, 0.47881835170310555, -0.2947237352277014, -0.010411790856394987, -0.0574357080575334, 0.03717238607494355, 1.369295009747887, -0.3279294446722199,
//				0.006839396350254212, 0.0012791215175802506, -0.004647070034093684, 0.4929398207148915, 1.5349223806867252, 0.02569956384857086, 0.009315857847679965, -0.0322612273194145, -0.30220718116420364, 0.29871743498635456, -0.05115813707958505, 0.005758453383532647, -0.041686436631336754, 1.3542792547338187, -0.11994939675175476, 0.04427657650827488, 0.03315054862983757, 0.03927111116833615, 1.4479743781050936, 0.30891137075437747,
//				0.004555124324400417, 0.03660514622244504, -0.03153178154714986, 1.5338404544406605, -0.029319448188458986, -0.010102167941477003, 0.005963097889155389, 0.014657586111646026, 0.5343301049723307, 1.0016248857323817, -0.0023650027593806744, 0.04097466850121778, 0.04689001630757694, 0.31839342675853677, 1.484021863386632, 0.00196598575070972, -0.00833577548625053, -0.016402783763205253, -0.44236445030468474, 0.301269803413487,
//				-0.019076025454419776, -0.03796392796863701, -0.03273052102093987, 1.3000657595052874, 0.12471404690703486, 0.049482384987505235, 0.0368947368839625, 0.03883876551691623, 1.4331362972250579, 0.2042368346473069, -0.03526759096110954, -0.020473380839603816, 0.04344688581139522, 0.3632876422024365, 1.6047359698208246, 0.031564357919215524, -0.018455019234227432, -0.01717091865414133, 0.12404956670243551, -0.8128451351053569,
//				-0.00634589881073004, -0.006662598204012771, 0.019652068505468634, -0.10140562345361086, 0.6801586743802628, 0.004616525593678311, 0.0013200218938214103, -0.03324543067166452, -0.29453664317738937, 0.20917691136847466, -0.004602048471431141, 0.004905653976191886, -0.008589276964793946, 0.4772181021963016, -0.2928272214373856, -0.012688630500927278, -0.051912339884088166, 0.03700562988150535, 1.3603170984825534, -0.32246594986008464,
//				0.003211691659218622, -0.003665655101466963, -0.0028685891127345855, 0.46545908511397444, 1.5387211975885584, 0.004464447477598998, -9.621878379295623E-5, -0.03461665751031173, -0.3052842257712881, 0.2950516367067709, -0.054499012815249236, -0.0028078480382921294, -0.0381948143643136, 1.359748414902776, -0.11436360752137047, 0.050110073007091804, 0.023338828525418798, 0.038993569857295185, 1.4459963525570105, 0.3151831762971556,
//				0.012349229080342194, 0.036409652636542944, -0.034138026872417626, 1.5301103821262616, -0.010167371794899138, 0.02192240447213034, -0.0021789682757455964, 0.007211813395120004, 0.5365815613806423, 1.0082091855514352, -0.0017473688390179376, 0.04580498254055376, 0.03916191727588014, 0.32851323145464, 1.4842569890601738, -2.2600409810948538E-4, 0.011734991635511172, -0.025002520000861672, -0.4376215020096776, 0.30186290421719786,
//				-0.030463874201922092, -0.027049924267024572, -0.03491267357194312, 1.294841901020086, 0.11728433046887261, 0.041116808082389114, 0.032607808797679105, 0.04079636677944842, 1.4370819810088284, 0.19315511240463837, -0.033449181377954273, -0.02323241674566745, 0.04513310282175986, 0.35723048369497157, 1.6044468483812622, 0.03316362988314595, -0.020490670512230302, -0.0194196636285362, -0.28265743341693256, 1.803546674085858,
//				-0.024072475923320624, -0.018779288212019907, -0.0038234498363429736, 0.4783888481943345, -0.3376312753673228, -0.02910576504730855, -0.03951634212381805, 0.03494851457403492, 1.382525375412041, -0.19470127727601955, 0.006591952716625826, 0.07427631254286737, -0.0012296744480941868, -0.25150699703743595, 0.6950296741918606, 0.02682741044533543, -0.016999460974931324, -0.019518939091769827, 0.14536240974333686, 1.2538269716415107,
//				0.007045337790815509, 0.011088726594040033, -0.004101388203892183, 0.9833012120167766, -1.473973069155895, 0.021584391478043585, -0.014295416952300855, 0.010126937997092966, 0.4788202296049263, -0.5901801584316893, -0.051277068728984965, -0.052462754129195766, 0.0072773670299177695, 0.23255363787658453, -0.19666717654799765, 0.004578068670079816, -0.012972765980277856, -0.015350293168850726, -0.44191708789484313, 0.1838991442674999,
//				-0.0018181625833948445, -0.00696015742948175, 5.69399109618729E-4, 0.4253137669624448, 1.4919877832759398, 0.0031343612174294933, -0.02634474993421776, -0.008735696424238881, -0.24987341673598332, 1.8079134916873572, -0.03768479316367479, 0.041415669060804294, -0.04194873804396959, 1.4262580129637406, -0.149112164682968, 0.0031685561506371585, -0.04645941078129834, 0.010017166761733698, 0.28467608170186764, -0.6202480348412514,
//				-0.007361246432505908, 0.006470267822134446, 0.020145164830750604, 0.08408026723701278, -0.17312112195198615, 0.04521186168791225, -3.79603232470771E-4, -0.005020358893730759, -0.15050551535846723, -1.5511775925745475, 0.008875791673242261, 0.00350428287285931, -0.0011601381627617258, 1.0166018529637422, -1.463007006934328, 0.044164991043992075, 0.017981267769163534, 0.015227870050196657, 0.32133505862210504, 1.0770552864161718,
//				-0.002065889183516134, -0.019658709156183247, -0.006292523491570279, 0.4803777777311716, -0.32977229885512627, -0.010405467509384536, -0.04987168291555344, 0.036635872636033184, 1.3758410438678055, -0.1989063231497832, 0.010132094623726662, 0.07015278169619145, 0.0062962488631441715, -0.24151870324951352, 0.6957172538756038, 0.020398626671886078, -0.02748644611474549, -0.016113683807368773, 0.144944961787884, 1.2566387699865504,
//				-0.009359534741304465, 0.020458610194256818, -0.00645195386781916, -0.5161953879118748, 0.7787387332431296, -0.0016484578604032407, 0.006123001626232583, 0.012772065210074235, 0.4824896088976948, -0.5810478352110656, -0.05395152466833286, -0.04693629288875884, 0.0054957681788510016, 0.22668334572707227, -0.1980036202003537, 0.013071110988422951, -0.015228305809341647, -0.021985218135089468, -0.43716449624351134, 0.18410979986425716,
//				-0.0024125325416877175, -0.00918816137736167, -0.003018352467954344, 0.42926045210912317, 1.4898981927106159, 0.025084644860868366, -0.024365671944578615, -0.009693959657331774, 0.10826929046597003, -0.7994698983721287, -0.031187482052741133, 0.04983732523326401, -0.04256209146590528, 1.4170293417371826, -0.1513820784138991, 0.0032162158094948268, -0.050826500931171026, 0.0099091483070608, 0.2815101004386191, -0.6247958093217234,
//				-0.017932433317848773, 0.013885684054689929, 0.017007945463733902, 0.08731664768730112, -0.16920435036536327, 0.03301559370649132, -0.00570200483120864, -0.003166349879330621, 0.1135835455402129, 1.2551029173284776, 0.010024190575681713, -1.8287691165363995E-4, -0.002402239502814041, 1.022837648907516, -1.4612939243752125, 0.0390186701389883, 0.016647879840892443, 0.017840204212983934, -0.4724732660463284, -1.5837773086209468};

        if (false) {
            for (int i = 1; i < u.length; i++) {
                int counter = 1;
                boolean flip = false;
                boolean antiflipx = true;
                int yCounter = 2;

                //if (u[i] != 0.0){
                if (i == 1) {
                    for (int j = 3; j < numDOF; j += 20) {
                        //System.out.println("cellDOFin1Dim_u[3]: " + cellDOFin1Dim*counter);
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            //System.out.println("numDOF " + numDOF+" "+counter + " flip: " + flip);
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                //System.out.println("*************************ONCE x!!");
                                flip = !flip;
                                antiflipx = false;
                            }

                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                //System.out.println("*************************ONCE y!!");
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {

                            newU[j + (cellDOFin1Dim / nC[2])] = u[i];
                            //System.out.println("FLIP; new[" + j + "]: " + newU[j] );
                        } else {

                            newU[j] = u[i];
                            //System.out.println("NO FLIP; new[" + j + "]: " + newU[j] );
                        }
                    }
                    //System.exit(1);
                } else if (i == 2) {
                    for (int j = 4; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j + (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else if (i == 3) {
                    for (int j = 8; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j + (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else if (i == 4) {
                    for (int j = 9; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j + (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else if (i == 5) {
                    for (int j = 13; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j - (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else if (i == 6) {
                    for (int j = 14; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j - (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else if (i == 7) {
                    for (int j = 18; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j - (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                } else {
                    for (int j = 19; j < numDOF; j += 20) {
                        if (j > cellDOFin1Dim * counter) {
                            flip = !flip;
                            ++counter;

                            if ((j > nC[1] * nC[2] * 2 * 5) && antiflipx) {
                                flip = !flip;
                                antiflipx = false;
                            }
                            if ((j > nC[1] * nC[2] * 2 * 5 * yCounter)) {
                                flip = !flip;
                                ++yCounter;
                            }
                        }
                        if (flip) {
                            newU[j - (cellDOFin1Dim / nC[2])] = u[i];
                        } else {
                            newU[j] = u[i];
                        }
                    }
                }

                //}

            }
        }
        for (int cell = 0; cell < numCells; cell++) {
            IMoleculeList molecules = coordinateDef.getBasisCells()[cell].molecules;
            coordinateDef.setToU(molecules, newU);
        }

        //System.exit(1)
        double rC = box.getBoundary().getBoxSize().getX(0) * 0.5;
        System.out.println("Truncation Radius: " + rC);
        potential = new P2Nitrogen(space, rC);
        potential.setBox(box);

        BoxInflate boxInflate = new BoxInflate(box, space);
        boxInflate.setScale(newScale);
        boxInflate.actionPerformed();

//		ConfigurationFile configFile = new ConfigurationFile("configFile"+numMolecule);
//		configFile.initializeCoordinates(box);

        potentialMaster.addPotential(potential, new ISpecies[]{species, species});

        MCMoveMoleculeCoupled move = new MCMoveMoleculeCoupled(potentialMaster, getRandom(), space);
        move.setBox(box);
        move.setPotential(potential);

        MCMoveRotateMolecule3D rotate = new MCMoveRotateMolecule3D(potentialMaster, getRandom(), space);
        rotate.setBox(box);

        MCMoveVolume mcMoveVolume = new MCMoveVolume(this, potentialMaster, space);
        mcMoveVolume.setBox(box);
        pressure *= 1e9;
        mcMoveVolume.setPressure(Pascal.UNIT.toSim(pressure));

        integrator = new IntegratorMC(this, potentialMaster, box);
        integrator.getMoveManager().addMCMove(move);
        integrator.getMoveManager().addMCMove(rotate);
        //integrator.getMoveManager().addMCMove(mcMoveVolume);

        integrator.setTemperature(Kelvin.UNIT.toSim(temperature));

        activityIntegrate = new ActivityIntegrate(integrator);
        getController().addAction(activityIntegrate);
    }
	
	public static void main (String[] args){
		
		int nC0 =3; 
		int nC1 =3; 
		int nC2 =3;
		double temperature =10; // in Unit Kelvin
		double pressure = 0.0; //in Unit GPa
		long simSteps = 100000;
		double newScale = 1.0;
		if(args.length > 1){
			simSteps = Long.parseLong(args[1]);
		}
		if(args.length > 2){
			temperature = Double.parseDouble(args[2]);
		}
		if(args.length > 3){
			pressure = Double.parseDouble(args[3]);
		}
		if(args.length > 4){
			nC0 = Integer.parseInt(args[4]);
		}
		if(args.length > 5){
			nC1 = Integer.parseInt(args[5]);
		}
		if(args.length > 6){
			nC2 = Integer.parseInt(args[6]);
		}
		if(args.length > 7){
			newScale = Double.parseDouble(args[7]);
		}
		
		int[] nC = new int []{nC0,nC1,nC2};
		int numMolecule =nC[0]*nC[1]*nC[2]*2;
		
		String filename = "betaN2_nA"+numMolecule+"_T"+Math.round(temperature);
		
		if(args.length > 0){
			filename = args[0];
		} 
		System.out.println("Running beta-N2 crystal structure simulation with " + simSteps + " steps" );
		System.out.println("num Molecules: " + numMolecule+ " ; temperature: " + temperature
				+"K ; pressure: "+ pressure+"GPa");
		System.out.println("With volume scaling of " + newScale);
		System.out.println("Output file: " + filename + "\n");

		
		SimulationBetaNitrogenModelTest sim = new SimulationBetaNitrogenModelTest(Space3D.getInstance(3), nC, temperature, pressure, newScale);
	    
		MeterPotentialEnergy meterPotentialEnergy = new MeterPotentialEnergy(sim.potentialMaster, sim.box);
		System.out.println("Lattice Energy (per molecule): "+ meterPotentialEnergy.getDataAsScalar()/numMolecule);
		//System.exit(1);
		
		AccumulatorAverage energyAverage = new AccumulatorAverageCollapsing();
		DataPump energyPump = new DataPump(meterPotentialEnergy, energyAverage);
		
		IntegratorListenerAction energyListener = new IntegratorListenerAction(energyPump);
		energyListener.setInterval(100);
		sim.integrator.getEventManager().addListener(energyListener);
		
//		MeterPressureMolecular meterPressure = new MeterPressureMolecular(sim.space);
//		meterPressure.setIntegrator(sim.integrator);
//						
//		AccumulatorAverage pressureAverage = new AccumulatorAverageCollapsing();
//		DataPump pressurePump = new DataPump(meterPressure, pressureAverage);
//		IntegratorListenerAction pressureListener = new IntegratorListenerAction(pressurePump);
//		pressureListener.setInterval((int)simSteps/100);
//		sim.integrator.getEventManager().addListener(pressureListener);
			
//		double staticPressure = meterPressure.getDataAsScalar();
//		System.out.println("Static Pressure (GPa): " + Pascal.UNIT.fromSim(staticPressure)/1e9);
		
		
		if(true){
			SimulationGraphic simGraphic = new SimulationGraphic(sim);
		    simGraphic.getDisplayBox(sim.box).setPixelUnit(new Pixel(20));
		    simGraphic.makeAndDisplayFrame("Beta-Phase Nitrogen Crystal Structure");
		    
		    DiameterHashByType diameter = new DiameterHashByType();
			diameter.setDiameter(sim.species.getNitrogenType(), 3.1);
			diameter.setDiameter(sim.species.getPType(), 0.0);
			
			simGraphic.getDisplayBox(sim.box).setDiameterHash(diameter);
			return;
		}
		
		sim.activityIntegrate.setMaxSteps(simSteps/5);
		sim.getController().actionPerformed();
		System.out.println("****System Equilibrated (20% of SimSteps)****");
		
		long startTime = System.currentTimeMillis();
		System.out.println("\nStart Time: " + startTime);
		sim.integrator.getMoveManager().setEquilibrating(false);
		sim.getController().reset();

		
		sim.activityIntegrate.setMaxSteps(simSteps);
		sim.getController().actionPerformed();
		
		
		double averageEnergy = energyAverage.getData().getValue(energyAverage.AVERAGE.index);
		double errorEnergy = energyAverage.getData().getValue(energyAverage.ERROR.index);
		
//		double averagePressure = ((DataGroup)pressureAverage.getData()).getValue(AccumulatorAverage.StatType.AVERAGE.index);
//		double errorPressure = ((DataGroup)pressureAverage.getData()).getValue(AccumulatorAverage.StatType.ERROR.index);
		
		System.out.println("Average energy (per molecule): "   + averageEnergy/numMolecule  
				+ " ;error: " + errorEnergy/numMolecule);
//		System.out.println("Average pressure (GPa): " + Pascal.UNIT.fromSim(averagePressure)/1e9 
//				+ " ;error: " + Pascal.UNIT.fromSim(errorPressure)/1e9);
		
		double[] u = sim.coordinateDef.calcU(sim.box.getMoleculeList());
		
		for (int i=0; i<u.length; i++){
			
			System.out.print (u[i] + ", ");
			if(i>1 && i%20==19){
				System.out.println("");
			}
		}
		
		
		double  a = sim.box.getBoundary().getEdgeVector(0).getX(0)/nC0;
		double  c = sim.box.getBoundary().getEdgeVector(2).getX(2)/nC2;
		System.out.println("\na: " +a + " ;c: "+c +" ;c/a: " + (c/a));
		double scaling = sim.box.getBoundary().getEdgeVector(0).getX(0)/(nC0*3.854);
	    System.out.println("scaling: " + scaling);
	    long endTime = System.currentTimeMillis();
		System.out.println("End Time: " + endTime);
		System.out.println("Time taken: " + (endTime - startTime));
			

			
	}

	protected Box box;
	protected Space space;
	protected PotentialMaster potentialMaster;
	protected IntegratorMC integrator;
	protected ActivityIntegrate activityIntegrate;
	protected PotentialMolecular potential;
	protected CoordinateDefinitionNitrogen coordinateDef;
	protected Primitive primitive;
	protected SpeciesN2 species;
	private static final long serialVersionUID = 1L;
}
